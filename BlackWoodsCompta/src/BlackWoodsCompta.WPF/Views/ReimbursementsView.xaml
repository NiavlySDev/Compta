<UserControl x:Class="BlackWoodsCompta.WPF.Views.ReimbursementsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewmodels="clr-namespace:BlackWoodsCompta.WPF.ViewModels"
             xmlns:helpers="clr-namespace:BlackWoodsCompta.WPF.Helpers"
             d:DataContext="{d:DesignInstance Type=viewmodels:ReimbursementsViewModel}"
             mc:Ignorable="d"
             Background="#1E1E1E">
    
    <UserControl.Resources>
        <helpers:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid>
        <!-- Dialog Overlay pour ajouter/modifier remboursement -->
        <Grid Visibility="{Binding IsAddingReimbursement, Converter={StaticResource BooleanToVisibilityConverter}}"
              Background="#CC000000"
              Panel.ZIndex="1000">
            <Border Width="600" Background="#2D2D30" Padding="30" CornerRadius="10" 
                    BorderBrush="#673AB7" BorderThickness="2"
                    HorizontalAlignment="Center" VerticalAlignment="Center">
                <StackPanel>
                    <TextBlock Text="ðŸ’° Demande de Remboursement" FontSize="24" FontWeight="Bold" Foreground="White" Margin="0,0,0,20"/>

                    <TextBlock Text="EmployÃ©" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding AvailableEmployees}" 
                             SelectedItem="{Binding SelectedEmployee}" 
                             DisplayMemberPath="Name"
                             IsEditable="False"
                             Background="#2D2D30" Foreground="White" BorderBrush="#3E3E42" BorderThickness="1" Padding="10" FontSize="14" Margin="0,0,0,15"/>

                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="20"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Montant ($)" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <TextBox Text="{Binding NewAmount, UpdateSourceTrigger=PropertyChanged}" 
                                     Background="#2D2D30" Foreground="White" BorderBrush="#3E3E42" BorderThickness="1" Padding="10" FontSize="14"/>
                        </StackPanel>
                        
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Date de demande" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                            <DatePicker SelectedDate="{Binding NewRequestDate}" 
                                       Background="#2D2D30" Foreground="White" BorderBrush="#3E3E42" BorderThickness="1" Padding="10" FontSize="14"/>
                        </StackPanel>
                    </Grid>

                    <TextBlock Text="Description" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding NewDescription, UpdateSourceTrigger=PropertyChanged}" 
                             Background="#2D2D30" Foreground="White" BorderBrush="#3E3E42" BorderThickness="1" Padding="10" FontSize="14"
                             TextWrapping="Wrap" AcceptsReturn="True" Height="80" Margin="0,0,0,15"/>

                    <TextBlock Text="Notes (optionnel)" Foreground="#AAAAAA" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding NewNotes, UpdateSourceTrigger=PropertyChanged}" 
                             Background="#2D2D30" Foreground="White" BorderBrush="#3E3E42" BorderThickness="1" Padding="10" FontSize="14"
                             TextWrapping="Wrap" AcceptsReturn="True" Height="60" Margin="0,0,0,20"/>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Annuler" Command="{Binding CancelCommand}" Background="Transparent" Foreground="White" BorderBrush="White" BorderThickness="1" Padding="15,8" Margin="0,0,15,0"/>
                        <Button Content="Enregistrer" Command="{Binding SaveReimbursementCommand}" Background="#673AB7" Foreground="White" BorderThickness="0" Padding="15,8"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Main Content -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

        <!-- Title -->
        <TextBlock Grid.Row="0" 
                   Text="Gestion des Remboursements" 
                   FontSize="24" 
                   FontWeight="Bold" 
                   Foreground="White" 
                   Margin="16"/>

        <!-- Summary Cards -->
        <Grid Grid.Row="1" Margin="16,0,16,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Total Pending -->
            <Border Grid.Column="0" 
                    Background="#FF9800" 
                    CornerRadius="8" 
                    Padding="16" 
                    Margin="0,0,8,0">
                <StackPanel>
                    <TextBlock Text="ðŸ’° Total Ã  Rembourser" 
                               FontSize="14" 
                               FontWeight="Bold" 
                               Foreground="White" 
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding TotalPendingAmount, StringFormat=C2}" 
                               FontSize="20" 
                               FontWeight="Bold" 
                               Foreground="White" 
                               HorizontalAlignment="Center" 
                               Margin="0,8,0,0"/>
                </StackPanel>
            </Border>

            <!-- Count Active -->
            <Border Grid.Column="1" 
                    Background="#2196F3" 
                    CornerRadius="8" 
                    Padding="16" 
                    Margin="4,0">
                <StackPanel>
                    <TextBlock Text="ðŸ“‹ Remboursements Actifs" 
                               FontSize="14" 
                               FontWeight="Bold" 
                               Foreground="White" 
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding Reimbursements.Count}" 
                               FontSize="20" 
                               FontWeight="Bold" 
                               Foreground="White" 
                               HorizontalAlignment="Center" 
                               Margin="0,8,0,0"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Filters and Controls -->
        <Border Grid.Row="2" 
                Background="#2D2D2D" 
                CornerRadius="8" 
                Margin="16,0,16,16" 
                Padding="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Filter by Status -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="ðŸ“Š Filtrer par statut:" Foreground="White" VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <ComboBox SelectedItem="{Binding FilterStatus}" 
                              Width="150" 
                              Height="35"
                              Background="#2D2D2D"
                              Foreground="White"
                              BorderBrush="#673AB7">
                        <ComboBoxItem Content="Tous"/>
                        <ComboBoxItem Content="En_Attente"/>
                        <ComboBoxItem Content="Approuve"/>
                        <ComboBoxItem Content="Paye"/>
                        <ComboBoxItem Content="Rejete"/>
                    </ComboBox>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="1" 
                           Orientation="Horizontal" 
                           VerticalAlignment="Center" 
                           Margin="16,0">
                    <Button Content="âž• Ajouter" 
                            Command="{Binding AddReimbursementCommand}" 
                            Width="100"
                            Background="#673AB7"
                            Foreground="White"
                            Padding="8"
                            Margin="4"/>
                    <Button Content="âœ… Approuver" 
                            Command="{Binding ApproveReimbursementCommand}" 
                            CommandParameter="{Binding SelectedReimbursement}"
                            Width="100"
                            Background="#4CAF50"
                            Foreground="White"
                            Padding="8"
                            Margin="4"/>
                    <Button Content="ðŸ’³ Payer" 
                            Command="{Binding PayReimbursementCommand}" 
                            CommandParameter="{Binding SelectedReimbursement}"
                            Width="100"
                            Background="#2196F3"
                            Foreground="White"
                            Padding="8"
                            Margin="4"/>
                    <Button Content="âŒ Rejeter" 
                            Command="{Binding RejectReimbursementCommand}" 
                            CommandParameter="{Binding SelectedReimbursement}"
                            Width="100"
                            Background="#F44336"
                            Foreground="White"
                            Padding="8"
                            Margin="4"/>
                </StackPanel>

                <!-- Loading Indicator -->
                <StackPanel Grid.Column="2" 
                           VerticalAlignment="Center" 
                           Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <ProgressBar IsIndeterminate="True" Width="100" Height="20"/>
                    <TextBlock Text="Chargement..." Foreground="White" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Reimbursements Cards -->
        <ScrollViewer Grid.Row="3" 
                     VerticalScrollBarVisibility="Auto"
                     Margin="16,0,16,16">
            <ItemsControl ItemsSource="{Binding Reimbursements}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="#2D2D2D" 
                                BorderBrush="#673AB7" 
                                BorderThickness="2" 
                                CornerRadius="10" 
                                Padding="20" 
                                Margin="0,0,0,15"
                                Cursor="Hand">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#3D3D3D"/>
                                        </Trigger>
                                        <DataTrigger Binding="{Binding Status}" Value="En_Attente">
                                            <Setter Property="BorderBrush" Value="#FF9800"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Approuve">
                                            <Setter Property="BorderBrush" Value="#4CAF50"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Paye">
                                            <Setter Property="BorderBrush" Value="#2196F3"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding Status}" Value="Rejete">
                                            <Setter Property="BorderBrush" Value="#F44336"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Left Section: Info -->
                                <StackPanel Grid.Column="0">
                                    <!-- Header with Employee and Amount -->
                                    <Grid Margin="0,0,0,10">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0"
                                                  Text="ðŸ‘¤" 
                                                  FontSize="24" 
                                                  VerticalAlignment="Center"
                                                  Margin="0,0,10,0"/>
                                        
                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="{Binding Employee.Name}" 
                                                      FontSize="18" 
                                                      FontWeight="Bold" 
                                                      Foreground="White"/>
                                            <TextBlock Text="{Binding Employee.Position}" 
                                                      FontSize="12" 
                                                      Foreground="#AAAAAA"/>
                                        </StackPanel>
                                        
                                        <TextBlock Grid.Column="2"
                                                  Text="{Binding Amount, StringFormat='{}${0:N2}'}" 
                                                  FontSize="24" 
                                                  FontWeight="Bold" 
                                                  Foreground="#4CAF50"
                                                  VerticalAlignment="Center"/>
                                    </Grid>
                                    
                                    <!-- Description -->
                                    <Border Background="#1E1E1E" 
                                           CornerRadius="5" 
                                           Padding="10" 
                                           Margin="0,0,0,10">
                                        <TextBlock Text="{Binding Description}" 
                                                  TextWrapping="Wrap" 
                                                  Foreground="White"
                                                  FontSize="13"/>
                                    </Border>
                                    
                                    <!-- Dates and Status Info -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="ðŸ“… Date demande" 
                                                      FontSize="11" 
                                                      Foreground="#888888"/>
                                            <TextBlock Text="{Binding RequestDate, StringFormat='dd/MM/yyyy HH:mm'}" 
                                                      FontSize="12" 
                                                      Foreground="White"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="âœ… Date approbation" 
                                                      FontSize="11" 
                                                      Foreground="#888888"/>
                                            <TextBlock Text="{Binding ApprovedDate, StringFormat='dd/MM/yyyy HH:mm', TargetNullValue='N/A'}" 
                                                      FontSize="12" 
                                                      Foreground="White"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="ðŸ“Š Statut" 
                                                      FontSize="11" 
                                                      Foreground="#888888"/>
                                            <Border CornerRadius="12" 
                                                   Padding="8,4" 
                                                   HorizontalAlignment="Left"
                                                   Margin="0,2,0,0">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Status}" Value="En_Attente">
                                                                <Setter Property="Background" Value="#FF9800"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Status}" Value="Approuve">
                                                                <Setter Property="Background" Value="#4CAF50"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Status}" Value="Paye">
                                                                <Setter Property="Background" Value="#2196F3"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Status}" Value="Rejete">
                                                                <Setter Property="Background" Value="#F44336"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding Status}" 
                                                          FontSize="11" 
                                                          FontWeight="Bold" 
                                                          Foreground="White"/>
                                            </Border>
                                        </StackPanel>
                                    </Grid>
                                    
                                    <!-- Notes if available -->
                                    <Border Background="#1E1E1E" 
                                           CornerRadius="5" 
                                           Padding="10" 
                                           Margin="0,10,0,0"
                                           Visibility="{Binding Notes, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <StackPanel>
                                            <TextBlock Text="ðŸ“ Notes" 
                                                      FontSize="11" 
                                                      Foreground="#888888"
                                                      Margin="0,0,0,5"/>
                                            <TextBlock Text="{Binding Notes}" 
                                                      TextWrapping="Wrap" 
                                                      Foreground="#CCCCCC"
                                                      FontSize="12"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                                
                                <!-- Right Section: Action Buttons -->
                                <StackPanel Grid.Column="1" 
                                           VerticalAlignment="Center"
                                           Margin="20,0,0,0">
                                    <Button Content="âœ… Approuver" 
                                           Command="{Binding DataContext.ApproveReimbursementCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                           CommandParameter="{Binding}"
                                           Background="#4CAF50"
                                           Foreground="White"
                                           BorderThickness="0"
                                           Padding="15,8"
                                           Margin="0,0,0,8"
                                           Width="120"/>
                                    
                                    <Button Content="ðŸ’³ Payer" 
                                           Command="{Binding DataContext.PayReimbursementCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                           CommandParameter="{Binding}"
                                           Background="#2196F3"
                                           Foreground="White"
                                           BorderThickness="0"
                                           Padding="15,8"
                                           Margin="0,0,0,8"
                                           Width="120"/>
                                    
                                    <Button Content="âŒ Rejeter" 
                                           Command="{Binding DataContext.RejectReimbursementCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                           CommandParameter="{Binding}"
                                           Background="#F44336"
                                           Foreground="White"
                                           BorderThickness="0"
                                           Padding="15,8"
                                           Width="120"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>